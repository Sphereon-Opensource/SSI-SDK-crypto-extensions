import {SphereonKeyManagementSystem} from "../SphereonKeyManagementSystem";
import {MemoryPrivateKeyStore} from "@veramo/key-manager";
import {ManagedKeyInfo} from "@veramo/core";
import * as u8a from 'uint8arrays'
import {generatePrivateKeyHex} from "@sphereon/ssi-sdk-ext.key-utils";

//const PRIVATE_KEY_HEX = '308204bf020100300d06092a864886f70d0101010500048204a9308204a50201000282010100dfdf529c3fc7f621f662be5aa54d0582860304582d0af5a497a9af8690fbf87d1c2c0936e4f994616aa79405e80614f8cd73eaba7e40d47f8d290d30dda34d697ca3b78cd98d06a64f5fbd455b60d93f60493f16d7e3582c0178f8a65defc40e52d51e90ca70ee13595d8cf973f095eee09ba7950f7fe095d0796fcbb6c23ea3a70a9374b3c75e857d57aba7c1932bf9f7eb569c9bc01ed6e0f92b981de1944d3f1fd7c0b87a4674d39171e3fb042b9db6f177d2402062e54ce67a03957015da3e61565d9cf65d961ed808aee81317cb15f6ef235e7ed063f6aa7e163638f2f9ad4988d9d142a6d761a7fe5d1222abfbf3d7f916bb226d408e81f2f6184c82a702030100010282010100d075a1f5ee8a230db2e07581f0844cca224172ed2c5c152a03333547677fc8fdae9aeea59807327c97949d87f66a9b62a5e4f7405ac9c155583b4e961efbaddcb8fbb5b1c8edc1b0611eb41e7e1d2b8e10f9836ea0ee882ec9dc3c24a639d9e4c08ac4a06c7145aeecbae8c76b872e05b64e1a78f96ac8d497c04c3273e661edc16cbc3d1a8cc6e81bc8d9df4688aacfb2fe23d6726c5a95843f7d26848c5cb6a9d163ba1dd194b840988fce5646204792103df50c15d7fb6085f1409e93f49769ca803a37168cc7b7905336b76ea2b400682019b047ccbaaf159816222230215c9a98fd446deefe7253ae7e80311d113ca07bb98ee38a6b49f1a7dd5aecf0f902818100f4d751ec23358533bbfad4107d10e823dffd45da035d91da13f13f839356ca114a9dc2f4216ceb4d8d651b2595a36565ee8c5722c7a757b1b70661e399acc32d340fa6b655f030ad4e4754331aafa89c62a0f72b7cf4c7186eef32acb4290543602bf5e47dd3072cd57166ca1cf769090df352f68677b1bc84eee8e75c2b721d02818100ea1359a7c7d6e143e23d336083431a84a81f08d1088a07a54d6083c7a5e7075148d2c0c790fbb7d035b007e62b21f6e2a91af4aca8e67fdd14048a96602153faa2375ddb34bf5b1fe9116df94d2cd2bd5f413e419e8155f9343dd469e5b35800b5877fe36da4308277a1cce111e8080528ff61d7f4f2d8f3ebb801a696212c93028180509f062ec7793c1f48ead3218acd22638dc20c5a39797a29611fb3565411e3ffc59e252fd641d3497a21accab77752503a38a408a3cd8aa6ce299fda1e24313095500209504b02fc4e2656a76d4622333c96dc4cc99ca0627f44ec5eca0427e383ab7610830e15f2c165d1ff0382c46762dc9898ecb645245a7180e78e061051028181008c9ea14ebd2c26da0c30ee0b7defb31f9c8c4054ab87987e42d4c7760a019790ca69e9ec39fa2e7c03b4c39a0fb170cacc026898cd42e3efa155f517cf9a56040cadac51c3076e2be66d551edeb11dcd2c4b5aa63b1dc1d35b0205f8b448a08694875959fc8515ab5b493576c4b61b135684cd77da2c860f4b3d98a8462a99c702818100cc0c9600fd6bf2a9dc17a0824475ae6c17edb3940cbe7d318bd2140b83a6ca487e36d9a4a08907b7bc33b3eb83bcb99edd87ea2451e739c95a2a69ddc9ae59389b99636eabd8cc016c266ffeb263cbeaeb5755a1f24c543977604053673150e07b3aee219d03e1d1d3400f7d4ba4559887ae5e49619ecd9f58c18ac0864f0e4d'
//const PRIVATE_KEY_HEX = '308204a2020100028201007f6ee486fdcc31cc939e3355db8b9f284280eb41fbddace176bf93a8b4c581983ee92efac0ff5fd46d19d41b225a55ed196e7a16fe880cdbe3a53ff781f00758ac013fb93357dda54a0ad43a9c075eb71c34a103d555e8d020dd324b977fbbb0e19f631ea2e0cd885af7991e5efc7bb0634a040d1d333b3a9c81466c758d741ab9d5456755a43a7c47afa11e5d250b43f8a531871d5b7814de7186acfaad4975bd00f9bdd0db11fe9479995a3984fdd104f4722a2d6457eceb50ca7e554883f571052d5fc54e848c25715eeb65bd4afb16e339987b8fca45db40373fb8c096943e50c69909e64a7bda7a6635730caff4f7d58e6338f36cd8ade95fd1e930876d02030100010282010054be2bded15c3f29aa6923fe4e9794e9b3000472c6c96db429c1d0b1fa34f5af86f68eb5562efd4d48984a8318df36110c3e79965d01a07b81f15c8e7dac5f564a5c324238b08fc6e16c3e2213ac9b01ee11d999b0ff066991d1472719c269d080d9fb925e025cebf6827d22c34be7fd2eaa03f3ac9d6b1fd8ffe7132d413a19a6249a86ca5c4313bcbd8bef8c032a1248067d7de73e9b2cbb5816f87e8763cc8559ae36e429469766d428cea8875deaab0ef509f621acc859302f6e6f946b984c51bea823932f53b9072704f1dbed7ce24d0499340f8b2ae5439a2bf8f3f3f3fbcc780609ea6cbf849cf046bda8153c80c31a1588abc5fdcebeb0d181909fc902818100fbe292afe554012222ea9e61260bfe276c1e89aa5a8db0f12f8d99541aa33a16f2215bc46c0794fdd6e890b3797d16e08c98d609eab589bf9538dc2141846fb2d57f06357860389f9ad4884897e55cde34a5bf3f7b91a3d4ff15d1081bafde1ab98ae283950c782c698d0ac586a91a483e62bafdc9ce8d16049ab024492d9003028181008183d72087e5a95873f782e12a10afa8e0bb1cfcbf10a214142d2f8521f83683d9bec8b8c11afe671d9ed9fed119bb9fd68e2628c5588be2173a1a310d37a0118c6a7812fdbde3bfd99fd578eadb181b679d8c2b03b967d3d5896e92924af934d468eb27323cb647adf185c15955b78162db48a3214b584303eda38a9a2307cf02818100ba1de3777703484719f7b489621c90723eb09dd6334ce9067db5aa2afbf7ca0f745ff3b7c27f23b72099fd79aff61ef652cd07b2922c0b9975406b5f6352e15a09e8ef04896ac7cc1f129594d62fd31c1958b364cc008446f928fca87a14cc0f8133bf45acd766e0a229666127ac41d049d0980cb89617a7c2452e8bd14a8a5302818030092919fcad5680e30a12f5d637381f87b27e8ed382a4ca93ad2aa9d32e8f7199aa24223a24fbe45cdd14f768b085a143df97119a183c518fd1d1f30d76eb1c771aea0c09268bb9154b2dceda34869d6b71c8920fa08d7cc8ff5f0e67c9fce1f6422fad6af98f95c853030bf24953755ea7fc29dce86804fb0901961f930c8b02818058301e9be2489997d4b09537af9d0023e4ab4307f5a0d6bb9ae3d891af70f33e15b5b7535906d2d7f3f2134d5c8ffea69ccc4efb195a0f566c8bf9672f99d68d46ee751379821a6cf7a894c6a35f5f27b2aec768f78bf72d86cd5b5a7b1e8a7d4dd7d5011f8eab9b227fdbd54f8a244e54e7078d9c9b44a7a119ccd622d474e6'
const UNSIGNED_JWT = 'eyJ0eXAiOiJvcGVuaWQ0dmNpLXByb29mK2p3dCIsImFsZyI6IlBTMjU2Iiwia2lkIjoiZGlkOmp3azpleUpyZEhraU9pSlNVMEVpTENKdUlqb2laakkzYTJoMk0wMU5ZM2xVYm1wT1ZqSTBkV1pMUlV0Qk5qQklOek5oZW1oa2NpMVVjVXhVUm1kYVp5MDJVemMyZDFBNVpqRkhNRm94UW5OcFYyeFlkRWRYTlRaR2RqWkpSRTUyYW5CVVh6Tm5aa0ZJVjB0M1FsQTNhM3BXT1RKc1UyZHlWVTl3ZDBoWWNtTmpUa3RGUkRGV1dHOHdRMFJrVFd0MVdHWTNkWGMwV2pscVNIRk1aM3BaYUdFNU5XdGxXSFo0TjNOSFRrdENRVEJrVFhwek5tNUpSa2RpU0ZkT1pFSnhOVEZWVm01V1lWRTJaa1ZsZG05U05XUktVWFJFTFV0VmVHaDRNV0psUWxSbFkxbGhjeTF4TVVwa1lqQkJMV0l6VVRKNFNDMXNTRzFhVjJwdFJWOWtSVVU1U0VseFRGZFNXRGRQZEZGNWJqVldVMGxRTVdOUlZYUllPRlpQYUVsM2JHTldOM0phWWpGTExYaGlhazlhYURkcU9IQkdNakJCTTFBM2FrRnNjRkV0VlUxaFdrTmxXa3RsT1hBMldtcFdla1JMWHpBNU9WZFBXWHBxZW1KT2FYUTJWbDlTTmxSRFNHSlJJaXdpWlNJNklrRlJRVUlpZlEjMCJ9.eyJpYXQiOjE3MDYwMjEyNzMsImV4cCI6MzQxMjA0MjYwNSwiYXVkIjoiaHR0cHM6Ly9lc2lnbmV0LmNvbGxhYi5tb3NpcC5uZXQiLCJub25jZSI6IlRnVWY0Z3dPaHZrTzV3eHVZNE1lIiwiaXNzIjoiTVVxMUg1TTRPQnI5ZnhTQzJmSnJZNGZlbFJteHREdzRpUmxzMmxCWlF6SSIsImp0aSI6ImVlNTYwMTg0LTU1YjUtNDkzNC1hZGI0LTBhMWFkZGE3ZGQzZSJ9'
describe('JWT test with RSA', () => {
    const kms = new SphereonKeyManagementSystem(new MemoryPrivateKeyStore())

    let key: ManagedKeyInfo
    it('should import pk', async () => {
        const privateKeyHex = await generatePrivateKeyHex('RSA')
        key = await kms.importKey(
            {
                //kid: '30820121300d06092a864886f70d01010105000382010e0030â€¦30caff4f7d58e6338f36cd8ade95fd1e930876d0203010001',
                privateKeyHex: privateKeyHex,
                type: 'RSA',
                meta: {algorithms: ['PS256']}
            })
        expect(key.type).toEqual('RSA')
        console.log('publicKeyHex:', key.publicKeyHex)
    })

    const data = u8a.fromString(UNSIGNED_JWT, 'utf-8')
    let signature: string
    let jwt: string
    it('should sign & verify JWT', async () => {
        signature = await kms.sign({keyRef: key, data, algorithm: 'PS256'})
        const result = await kms.verify({
            type: "RSA",
            publicKeyHex: key.publicKeyHex,
            data,
            signature
        })
        expect(result).toBeTruthy()

        jwt = [UNSIGNED_JWT, signature].join('.')
        console.log('JWT:', jwt)
    })

})